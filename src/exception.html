<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Exception</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"
    />
  </head>

  <body>
    <div id="root">
      <button id="btn">click me</button>
    </div>
    <script>
      let hasError = false;
      let caughtError = null;
      let workInProgress = 0;

      function renderRootSync() {
        // do {
        try {
          while (workInProgress < 5) {
            beginWork$1();
            workInProgress++;
          }
          // break;
        } catch (thrownValue) {
          // debugger;
          console.log("renderRootSync catch error======", thrownValue);
          //handleError(root, thrownValue);
        }
        // } while (true);
      }

      renderRootSync();

      function beginWork$1() {
        try {
          return beginWork();
        } catch (originalError) {
          console.log("beginWork catch error ====", originalError);
          invokeGuardedCallback(beginWork);
          if (caughtError) {
            const replayError = caughtError;
            caughtError = null;
            throw replayError
          }
        }
      }
      function beginWork() {
        console.log("beginwork...", workInProgress);
        if (workInProgress === 3) {
          throw Error("等于3的时候抛出一个错误");
        }
      }

      function invokeGuardedCallback(func) {
        const evt = document.createEvent("Event");
        const evtType = "react-invokeguardedcallback";
        const fakeNode = document.createElement("react");

        function callCallback() {
          fakeNode.removeEventListener(evtType, callCallback, false);
          // 执行回调函数
          func();
        }

        function handleWindowError(event) {
          caughtError = event.error;
        }

        // 注册全局异常监听器
        window.addEventListener("error", handleWindowError);
        // 注册自定义事件监听器，在自定义事件中调用用户提供的回调函数
        fakeNode.addEventListener(evtType, callCallback, false);

        evt.initEvent(evtType, false, false);
        fakeNode.dispatchEvent(evt);

        // 移除全局异常监听器
        window.removeEventListener("error", handleWindowError);
      }
    </script>
  </body>
</html>
